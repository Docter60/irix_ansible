- name: Create sshd user
  telnet:
    user: root
    password: 
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - echo "sshd::23:sshd" >> /etc/group

- name: Create sshd user
  telnet:
    user: root
    password: 
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - /usr/sysadm/privbin/addUserAccount -l sshd -u 23 -g 23 -H /dev/null -S /dev/null

- name: Check if key exists
  telnet:
    user: root
    password:
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - find /usr/nekoware/etc/ssh_host_ecdsa_key -type f
  register: keyname

- name: Create ssh keys
  telnet:
    user: root
    password:
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - /usr/nekoware/bin/ssh-keygen -f /usr/nekoware/etc/ssh_host_ecdsa_key -q -N ""
  when: "{{ 'nekoware' in keyname }}"

- name: Start sshd
  telnet:
    user: root
    password: 
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - chkconfig neko_sshd on


- name: Start sshd
  telnet:
    user: root
    password: 
    login_prompt: "login: "
    prompts:
      - "[>|#]"
    command:
      - /etc/init.d/neko_sshd start

- name: Make sure the known hosts file exists
  file: 
    path: /home/vagrant/.ssh/known_hosts 
    state: touch
  delegate_to: localhost


- name: ensure target hostkey exists
  lineinfile:
    dest: /home/vagrant/.ssh/known_hosts
    create: yes
    state: present
    line: "{{ lookup('pipe', 'ssh-keyscan ' + ansible_ssh_host) }}"
  delegate_to: localhost